# Track Order API - نظام تتبع الطلبات

## نظرة عامة

هذا الـ API مسؤول عن إدارة وتتبع طلبات العاملات المنزلية، ويوفر وظائف لعرض وتعديل معلومات الطلب.

## الميزات الرئيسية

### 1. عرض معلومات الطلب (GET)
- جلب جميع تفاصيل الطلب
- معلومات العميل
- معلومات العاملة المنزلية
- حالة الطلب والمراحل
- الملفات المرفقة
- تفاصيل التوصيل

### 2. تعديل معلومات الطلب (PATCH)
يدعم نوعين من التعديلات:

#### أ. تعديل الحالات (Status Updates)
- موافقة المكتب الخارجي
- الفحص الطبي
- موافقة العمالة الأجنبية
- دفع الوكالة
- موافقة السفارة السعودية
- إصدار التأشيرة
- تصريح السفر
- الاستلام
- حالة الحجز
- الحقول المخصصة (Custom Fields)

#### ب. تعديل الأقسام (Section Updates)
- معلومات العميل
- ملفات الطلب
- الفحص الطبي
- معلومات العاملة المنزلية
- معلومات ربط المكتب
- معلومات المكتب الخارجي
- الوجهات
- رفع المستندات
- طريقة الاستلام
- تفاصيل التوصيل

## نظام التسجيل (Logging System)

### السجلات المزدوجة
كل تعديل يتم حفظه في مكانين:

1. **systemUserLogs** - سجل أنشطة المستخدمين في النظام
   - يحتوي على معلومات عامة عن التعديل
   - مرتبط بالمستخدم والطلب

2. **logs** - سجل أنشطة العاملة المنزلية
   - يحتوي على تفاصيل التعديلات الخاصة بالعاملة
   - مرتبط بالعاملة والمستخدم

### بنية السجل في logs

```typescript
{
  userId: string,        // اسم المستخدم
  homemaidId: number,    // معرف العاملة
  Status: string,        // نوع التعديل
  Details: string,       // تفاصيل التعديل
  reason: string,        // سبب التعديل
  createdAt: DateTime,   // تاريخ ووقت التعديل
}
```

### أمثلة على السجلات

#### تعديل حقل مخصص
```json
{
  "Status": "تعديل حقل مخصص في الطلب",
  "Details": "تم تعديل حقل 'موافقة المكتب' في الطلب 123 من 'غير مكتمل' إلى 'مكتمل'",
  "reason": "تعديل في صفحة تتبع الطلب"
}
```

#### تعديل حالة الطلب
```json
{
  "Status": "تعديل حالة في الطلب",
  "Details": "تعديل الفحص الطبي في الطلب 123 من 'غير مكتمل' إلى 'مكتمل'",
  "reason": "تعديل حقل: medicalCheck"
}
```

#### تعديل قسم
```json
{
  "Status": "تعديل قسم destinations",
  "Details": "تم تعديل قسم 'destinations' في الطلب 123: مدينة المغادرة: من 'القاهرة' إلى 'الإسكندرية'",
  "reason": "تعديل في صفحة تتبع الطلب"
}
```

#### تغيير العاملة
```json
// للعاملة القديمة
{
  "Status": "إزالة من الطلب",
  "Details": "تم إزالة العاملة من الطلب 123 واستبدالها بعاملة أخرى (معرف: 456)",
  "reason": "تغيير العاملة في صفحة تتبع الطلب"
}

// للعاملة الجديدة
{
  "Status": "إضافة إلى الطلب",
  "Details": "تم إضافة العاملة إلى الطلب 123 (فاطمة أحمد)",
  "reason": "تغيير العاملة في صفحة تتبع الطلب"
}
```

## استخدام الـ API

### GET Request
```typescript
GET /api/track_order/[id]

Response:
{
  orderId: number,
  bookingStatus: string,
  clientInfo: {...},
  homemaidInfo: {...},
  applicationInfo: {...},
  // ... المزيد من البيانات
}
```

### PATCH Request - تعديل حالة

```typescript
PATCH /api/track_order/[id]

Body:
{
  field: "medicalCheck",
  value: true
}

Response:
{
  message: "Status updated successfully"
}
```

### PATCH Request - تعديل قسم

```typescript
PATCH /api/track_order/[id]

Body:
{
  section: "destinations",
  updatedData: {
    "مدينة المغادرة": "القاهرة",
    "مدينة الوصول": "الرياض"
  }
}

Response:
{
  message: "Section updated successfully"
}
```

## الأمان (Security)

- يتم استخدام JWT token للمصادقة
- يتم استخراج معلومات المستخدم من الـ token
- جميع التعديلات مسجلة ومرتبطة بالمستخدم

## معالجة الأخطاء

```typescript
// حالات الخطأ المحتملة:
- 404: Order not found
- 400: Invalid request / Validation error
- 500: Internal server error
- 405: Method not allowed
```

## الملفات ذات الصلة

- `[id].ts` - الملف الرئيسي للـ API
- `CHANGELOG.md` - سجل التغييرات
- `LOGS_QUERY_EXAMPLES.md` - أمثلة على استعلامات السجلات
- `README.md` - هذا الملف

## ملاحظات مهمة

1. **التوافقية**: النظام متوافق مع الإصدارات السابقة
2. **الأداء**: يتم استخدام transactions لضمان تناسق البيانات
3. **السجلات**: جميع التعديلات مسجلة تلقائياً
4. **المرونة**: يدعم الحقول المخصصة (Custom Fields)

## التطوير المستقبلي

- [ ] إضافة API endpoint لعرض السجلات
- [ ] إضافة صفحة UI لعرض سجل أنشطة العاملة
- [ ] إضافة فلاتر متقدمة للسجلات
- [ ] إضافة وظيفة تصدير السجلات
- [ ] إضافة إشعارات عند التعديلات المهمة

## الدعم

للمزيد من المعلومات أو الإبلاغ عن مشاكل، يرجى التواصل مع فريق التطوير.

