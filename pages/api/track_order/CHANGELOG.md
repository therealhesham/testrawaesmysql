# سجل التغييرات - Track Order API

## التحديث: إضافة تسجيل الأنشطة في model logs

### التاريخ
21 ديسمبر 2025

### الوصف
تم إضافة نظام تسجيل شامل لجميع التعديلات التي تتم في صفحة تتبع الطلب، بحيث يتم حفظ كل تعديل في:
1. **systemUserLogs** - سجل أنشطة المستخدمين في النظام
2. **logs** - سجل أنشطة العاملة المنزلية (homemaid)

### التغييرات المضافة

#### 1. دالة جديدة: `logToHomemaidLogs`
```typescript
async function logToHomemaidLogs(
  userId: string,
  homemaidId: number,
  status: string,
  details?: string,
  reason?: string
)
```

هذه الدالة تقوم بحفظ السجلات في جدول `logs` الخاص بالعاملة المنزلية.

**المعاملات:**
- `userId`: اسم المستخدم الذي قام بالتعديل
- `homemaidId`: معرف العاملة المنزلية
- `status`: حالة التعديل (مثل: "تعديل حقل مخصص في الطلب")
- `details`: تفاصيل التعديل
- `reason`: سبب التعديل

#### 2. الأماكن التي يتم فيها التسجيل

##### أ. تعديل الحقول المخصصة (Custom Fields)
عند تعديل أي حقل مخصص في timeline الطلب، يتم تسجيل:
- التعديل في `systemUserLogs`
- التعديل في `logs` الخاص بالعاملة

**مثال:**
```
Status: "تعديل حقل مخصص في الطلب"
Details: "تم تعديل حقل 'اسم_الحقل' في الطلب 123 من 'غير مكتمل' إلى 'مكتمل'"
Reason: "تعديل في صفحة تتبع الطلب"
```

##### ب. تعديل حالات الطلب (Status Updates)
عند تعديل حالات مثل:
- موافقة المكتب الخارجي
- الفحص الطبي
- موافقة العمالة الأجنبية
- دفع الوكالة
- موافقة السفارة السعودية
- إصدار التأشيرة
- تصريح السفر
- الاستلام
- حالة الحجز

يتم تسجيل التعديل في سجل العاملة مع تفاصيل التغيير.

**مثال:**
```
Status: "تعديل حالة في الطلب"
Details: "تعديل الفحص الطبي في الطلب 123 من 'غير مكتمل' إلى 'مكتمل'"
Reason: "تعديل حقل: medicalCheck"
```

##### ج. تعديل الأقسام (Section Updates)
عند تعديل أي قسم من أقسام الطلب مثل:
- معلومات العميل (clientInfo)
- ملفات الطلب (orderFiles)
- الفحص الطبي (medical)
- معلومات ربط المكتب (officeLinkInfo)
- معلومات المكتب الخارجي (externalOfficeInfo)
- الوجهات (destinations)
- رفع المستندات (documentUpload)
- طريقة الاستلام (receipt)
- تفاصيل التوصيل (deliveryDetails)

يتم تسجيل جميع التغييرات في سجل العاملة.

**مثال:**
```
Status: "تعديل قسم destinations"
Details: "تم تعديل قسم 'destinations' في الطلب 123: مدينة المغادرة: من 'القاهرة' إلى 'الإسكندرية' | مدينة الوصول: من 'جدة' إلى 'الرياض'"
Reason: "تعديل في صفحة تتبع الطلب"
```

##### د. تغيير العاملة في الطلب (homemaidInfo)
عند تغيير العاملة المرتبطة بالطلب، يتم:
1. تسجيل إزالة العاملة القديمة من الطلب في سجلها
2. تسجيل إضافة العاملة الجديدة إلى الطلب في سجلها

**مثال للعاملة القديمة:**
```
Status: "إزالة من الطلب"
Details: "تم إزالة العاملة من الطلب 123 واستبدالها بعاملة أخرى (معرف: 456)"
Reason: "تغيير العاملة في صفحة تتبع الطلب"
```

**مثال للعاملة الجديدة:**
```
Status: "إضافة إلى الطلب"
Details: "تم إضافة العاملة إلى الطلب 123 (فاطمة أحمد)"
Reason: "تغيير العاملة في صفحة تتبع الطلب"
```

### الفوائد

1. **تتبع كامل**: يمكن تتبع جميع التعديلات التي تمت على طلب العاملة
2. **المساءلة**: معرفة من قام بالتعديل ومتى
3. **التدقيق**: سهولة مراجعة تاريخ التعديلات
4. **الشفافية**: جميع التغييرات موثقة بشكل تلقائي

### ملاحظات تقنية

- يتم استخدام `token.username` للحصول على اسم المستخدم من JWT token
- في حالة عدم وجود username، يتم استخدام 'system' كقيمة افتراضية
- يتم التحقق من وجود `HomemaidId` قبل محاولة التسجيل
- جميع عمليات التسجيل محاطة بـ try-catch لمنع فشل العملية الأساسية

### الاختبار

للتأكد من عمل النظام:
1. قم بتعديل أي حقل في صفحة تتبع الطلب
2. تحقق من جدول `logs` في قاعدة البيانات
3. يجب أن تجد سجل جديد يحتوي على:
   - `userId`: اسم المستخدم
   - `homemaidId`: معرف العاملة
   - `Status`: نوع التعديل
   - `Details`: تفاصيل التعديل
   - `reason`: سبب التعديل
   - `createdAt`: تاريخ ووقت التعديل

### الملفات المعدلة

- `pages/api/track_order/[id].ts` - إضافة دالة `logToHomemaidLogs` وتطبيقها في جميع نقاط التعديل

