# نظام القائمة المالية - وصل للاستقدام

## نظرة عامة
تم تطوير نظام متقدم للقائمة المالية مع حسابات دقيقة للايرادات والمصروفات والزكاة.

## الميزات الجديدة

### 1. الحسابات المالية الصحيحة
- **الايرادات**: يتم جمعها (mathProcess: "add")
- **المصروفات**: يتم طرحها (mathProcess: "subtract")
- **مجمل الربح**: الايرادات - المصروفات المباشرة
- **صافي الربح قبل الزكاة**: مجمل الربح - المصروفات التشغيلية
- **صافي الربح بعد الزكاة**: صافي الربح قبل الزكاة - الزكاة

### 2. حساب الزكاة
- نسبة الزكاة قابلة للتعديل (افتراضياً 2.5%)
- يتم حساب الزكاة على صافي الربح قبل الزكاة
- الزكاة تُطرح من صافي الربح

### 3. API متقدم للحسابات
**Endpoint**: `/api/income-statements/calculations`

**المعاملات**:
- `zakatRate`: نسبة الزكاة (افتراضياً 2.5)
- `from`: تاريخ البداية (اختياري)
- `to`: تاريخ النهاية (اختياري)

**الاستجابة**:
```json
{
  "success": true,
  "data": {
    "months": ["2024-01", "2024-02", ...],
    "monthlyBreakdown": {
      "revenues": [1000, 1200, ...],
      "directExpenses": [-500, -600, ...],
      "operationalExpenses": [-200, -250, ...],
      "otherOperationalExpenses": [-100, -120, ...],
      "grossProfit": [500, 600, ...],
      "netProfitBeforeZakat": [200, 230, ...],
      "netProfitAfterZakat": [195, 224, ...]
    },
    "totals": {
      "revenues": 5000,
      "directExpenses": -2500,
      "grossProfit": 2500,
      "netProfitBeforeZakat": 2000,
      "zakatAmount": 50,
      "netProfitAfterZakat": 1950
    },
    "averages": {
      "revenues": 1000,
      "directExpenses": -500,
      "grossProfit": 500,
      "netProfitBeforeZakat": 400,
      "zakatAmount": 10,
      "netProfitAfterZakat": 390
    },
    "categories": {
      "mainCategories": [...],
      "monthlyData": {...},
      "categoryTotals": {...},
      "categoryAverages": {...}
    },
    "zakatRate": 2.5
  }
}
```

### 4. قاعدة البيانات
**الـ Models**:
- `IncomeStatement`: سجلات الدخل مع timestamps
- `mainCategory`: الفئات الرئيسية مع نوع العملية الحسابية
- `subCategory`: الفئات الفرعية المرتبطة بالفئات الرئيسية

**العلاقات**:
- `IncomeStatement` → `subCategory` → `mainCategory`
- كل فئة رئيسية لها فئات فرعية متعددة
- كل فئة رئيسية لها نوع عملية حسابية (add/subtract)

### 5. الواجهة الأمامية
- **نموذج إضافة**: يربط بين الفئات الرئيسية والفرعية ديناميكياً
- **جدول مالي**: يعرض البيانات الحقيقية من قاعدة البيانات
- **تحكم في نسبة الزكاة**: يمكن تعديل نسبة الزكاة في الوقت الفعلي
- **حسابات شهرية**: يعرض آخر 5 أشهر مع المتوسطات والمجاميع

## كيفية الاستخدام

### 1. إضافة سجل جديد
1. اضغط على "اضافة سجل"
2. اختر التاريخ
3. اختر البند الرئيسي (سيتم تحميل البنود الفرعية تلقائياً)
4. اختر البند الفرعي
5. أدخل المبلغ
6. أضف ملاحظات (اختياري)
7. اضغط "إضافة"

### 2. تعديل نسبة الزكاة
1. في أعلى الصفحة، غيّر قيمة "نسبة الزكاة"
2. سيتم إعادة حساب جميع القيم تلقائياً

### 3. عرض البيانات
- **المتوسط الشهري**: متوسط القيم لكل فئة
- **الاجمالي**: مجموع القيم لكل فئة
- **البيانات الشهرية**: تفصيل شهري للقيم

## الحسابات المالية

### معادلة مجمل الربح
```
مجمل الربح = الايرادات + المصروفات المباشرة على العقد
```
(المصروفات المباشرة سالبة في النظام)

### معادلة صافي الربح قبل الزكاة
```
صافي الربح قبل الزكاة = مجمل الربح + المصروفات التشغيلية + المصروفات الاخرى التشغيلية
```

### معادلة الزكاة
```
الزكاة = صافي الربح قبل الزكاة × (نسبة الزكاة / 100)
```

### معادلة صافي الربح بعد الزكاة
```
صافي الربح بعد الزكاة = صافي الربح قبل الزكاة - الزكاة
```

## الملفات المهمة

1. **API**: `pages/api/income-statements/calculations.ts`
2. **Frontend**: `pages/admin/incomestatments.tsx`
3. **Database Schema**: `prisma/schema.prisma`
4. **Categories API**: `pages/api/categories/mainCategory.ts`, `pages/api/categories/subCategory.ts`

## ملاحظات تقنية

- النظام يستخدم Prisma ORM للتفاعل مع قاعدة البيانات
- الحسابات تتم في الـ backend لضمان الدقة
- الواجهة الأمامية تستخدم React hooks لإدارة الحالة
- البيانات يتم تحديثها تلقائياً عند إضافة سجلات جديدة
- النظام يدعم التصفية حسب التاريخ
