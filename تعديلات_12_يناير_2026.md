# تقرير التعديلات - 12 يناير 2026

## ملخص التعديلات
تم إجراء **5 تعديلات** في تاريخ 12 يناير 2026 بواسطة hesham

---

## 1. تحسين إدارة الطلبات المرفوضة
**الوقت:** 12:55:33  
**الملفات المعدلة:**
- `pages/admin/rejectedorders.tsx`
- `pages/api/rejectedorderslist.ts`

### التغييرات:
- ✅ إضافة وظيفة لجلب الجنسيات الفريدة وعرضها في لوحة التحكم
- ✅ إضافة عمود "السبب" في جدول الطلبات المرفوضة
- ✅ إضافة نافذة منبثقة (Modal) لعرض سبب الرفض أو الإلغاء
- ✅ تحديث API لإرجاع حقول `ReasonOfRejection` و `ReasonOfCancellation`
- ✅ تحسين تجربة المستخدم في عرض البيانات

### الكود المضاف:
- دالة `fetchUniqueNationalities()` لجلب الجنسيات
- حالة `showReasonModal` و `selectedReason` لإدارة عرض السبب
- عمود جديد في الجدول لعرض الأسباب
- نافذة منبثقة لعرض تفاصيل السبب

---

## 2. تحديث فلتر حالة الحجز في API
**الوقت:** 10:52:29  
**الملفات المعدلة:**
- `pages/api/bookedlist.ts`

### التغييرات:
- ✅ تحديث منطق الفلترة لاستثناء الطلبات الملغاة (`cancelled`) من قائمة الحجوزات النشطة
- ✅ تحسين دقة استرجاع الحجوزات النشطة فقط

### التعديل:
```typescript
// قبل:
in: ["delivered", "rejected"]

// بعد:
in: ["delivered", "rejected", "cancelled"]
```

---

## 3. تحسين فحص التوفر في APIs
**الوقت:** 10:51:09  
**الملفات المعدلة:**
- `pages/api/availablelist.ts`
- `pages/api/homemaids/suggestions.ts`

### التغييرات:
- ✅ تحديث منطق فحص التوفر لضمان اعتبار الخادمة متاحة فقط إذا كانت جميع طلباتها إما `null` أو ملغاة/مرفوضة
- ✅ تحسين دقة قوائم التوفر والاقتراحات

### التعديل:
```typescript
// قبل:
OR: [
  { NewOrder: { every: { HomemaidId: null } } },
  { NewOrder: { some: { bookingstatus: { in: ["cancelled", "rejected"] } } } }
]

// بعد:
NewOrder: {
  every: {
    OR: [
      { HomemaidId: null },
      { bookingstatus: { in: ["cancelled", "rejected"] } }
    ]
  }
}
```

---

## 4. تحسين التحقق من رقم الهاتف
**الوقت:** 10:41:21  
**الملفات المعدلة:**
- `pages/admin/authorizations.tsx`
- `pages/api/submitneworderprisma.ts`

### التغييرات:
- ✅ تحديث منطق التحقق من رقم الهاتف للسماح بـ `+` في البداية
- ✅ تحديد الحد الأقصى لطول الرقم بـ 15 رقم
- ✅ إضافة خاصية `maxLength={16}` لحقل الإدخال
- ✅ إضافة وظيفة لحذف الطلبات الملغاة أو المرفوضة المرتبطة بالعاملة عند إنشاء طلب جديد

### التعديل:
```typescript
// قبل:
if (value === '' || /^\d+$/.test(value))

// بعد:
if (value === '' || /^\+?\d{0,15}$/.test(value))
maxLength={16}
```

### الكود المضاف في API:
- منطق لحذف الطلبات الملغاة/المرفوضة المرتبطة بالعاملة
- حذف `arrivallist` المرتبطة بهذه الطلبات قبل حذف الطلبات

---

## 5. تحديث فحص حالة الحجز في API
**الوقت:** 10:30:18  
**الملفات المعدلة:**
- `pages/api/submitneworderprisma.ts`

### التغييرات:
- ✅ تحديث فحص الطلبات الموجودة لاستثناء الطلبات الملغاة أو المرفوضة
- ✅ تحسين دقة التحقق من الحجز المسبق

### التعديل:
```typescript
// قبل:
where: { HomeMaid: { id: HomemaidId } }

// بعد:
where: { 
  HomeMaid: { id: HomemaidId },
  bookingstatus: {
    notIn: ['cancelled', 'rejected']
  }
}
```

---

## إحصائيات التعديلات

| الملف | الإضافات | الحذف | التغييرات |
|------|---------|------|-----------|
| `pages/admin/rejectedorders.tsx` | +84 | -11 | 91 |
| `pages/api/rejectedorderslist.ts` | +4 | -1 | 4 |
| `pages/api/bookedlist.ts` | +2 | -2 | 4 |
| `pages/api/availablelist.ts` | +26 | -8 | 18 |
| `pages/api/homemaids/suggestions.ts` | +18 | -4 | 14 |
| `pages/admin/authorizations.tsx` | +10 | -4 | 6 |
| `pages/api/submitneworderprisma.ts` | +40 | -4 | 36 |

**المجموع:** 194 سطر مضاف، 34 سطر محذوف

---

## ملاحظات عامة

1. **تحسين معالجة الطلبات الملغاة والمرفوضة:** جميع التعديلات تركز على تحسين معالجة الطلبات الملغاة والمرفوضة في النظام
2. **تحسين دقة البيانات:** تحديث الفلاتر والاستعلامات لضمان دقة أكبر في عرض البيانات
3. **تحسين تجربة المستخدم:** إضافة ميزات جديدة مثل عرض أسباب الرفض والإلغاء
4. **تنظيف البيانات:** إضافة منطق لحذف الطلبات القديمة الملغاة/المرفوضة تلقائياً

---

## Commit Hashes

- `d4f8648` - Enhance rejected orders management
- `7594f85` - Update booking status filter
- `16db1b1` - Refactor availability checks
- `d623ee5` - Refine phone number validation
- `f77a0fb` - Update booking status check





